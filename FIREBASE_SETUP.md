# Firebase Setup for HagzCoora Chat System

## Required Firebase Configuration

### 1. Firestore Database Rules
Copy this into your Firestore Rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // Allow reading other users for search
    }
    
    // Chat rules
    match /chats/{chatId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participants;
    }
    
    // Message rules
    match /chats/{chatId}/messages/{messageId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      allow write: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
        request.auth.uid == request.resource.data.senderId;
    }
  }
}
```

### 2. Firestore Indexes (Optional - for better performance)

If you want to order chats by lastMessageTime, you may need this composite index:

**Collection:** `chats`
**Fields to index:**
- `participants` (Arrays)
- `lastMessageTime` (Descending)

To create this index:
1. Go to Firebase Console
2. Navigate to Firestore Database
3. Click on "Indexes" tab
4. Click "Create Index"
5. Add the fields above

**Note:** Our current implementation sorts locally to avoid this requirement, but for large datasets, the index would improve performance.

### 3. Storage Rules (for media uploads)
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /chats/{chatId}/media/{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

### 4. Authentication Methods
Make sure these are enabled in Firebase Authentication:
- Email/Password
- Google Sign-In
- Any other methods you want to support

### 5. Firebase Configuration Files
Ensure you have the correct configuration files:
- `android/app/google-services.json` (for Android)
- `ios/Runner/GoogleService-Info.plist` (for iOS)
- `lib/firebase_options.dart` (generated by FlutterFire CLI)

## Testing the Chat System

### Quick Test Steps:
1. **Login** with your authentication method
2. **Home Screen** should show "No chats yet" initially
3. **Sample Chat** will be automatically created for testing
4. **Tap the chat** to open the chat page
5. **Send messages** to test real-time functionality
6. **Use + button** to create new chats
7. **Search users** (sample users are provided for testing)

### Sample Data Created:
- Demo users for testing chat creation
- Welcome chat with sample messages
- User document for the authenticated user

## Troubleshooting

### Common Issues:

1. **Index Required Error**
   - Solution: Our current implementation avoids complex queries
   - If you see index errors, they're now handled with local sorting

2. **Permission Denied**
   - Check Firestore security rules
   - Ensure user is authenticated
   - Verify user is in chat participants

3. **No Chats Showing**
   - Check Firebase connection
   - Verify authentication is working
   - Sample chat should auto-create on first login

4. **Media Upload Issues**
   - Check Storage security rules
   - Verify Firebase Storage is enabled
   - Check network connectivity

### Debug Information:
- Check Flutter console for any Firebase errors
- Use Firebase Console to view data structure
- Monitor Firestore usage in Firebase Console

## Production Considerations

1. **Security Rules**: Review and tighten for production
2. **Indexes**: Add composite indexes for better performance
3. **Cloud Functions**: Consider adding for:
   - Push notifications
   - User presence
   - Message moderation
4. **Backup**: Set up regular Firestore backups
5. **Monitoring**: Enable Firebase Performance Monitoring

## Next Features to Implement
- Push notifications with FCM
- User presence (online/offline status)
- Message encryption
- File sharing with size limits
- Voice messages
- Message search within chats
